-- Users and Authentication
CREATE TABLE users (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
hedera_account_id VARCHAR(50) UNIQUE NOT NULL,
email VARCHAR(255) UNIQUE,
phone_number VARCHAR(20),
kyc_token_id VARCHAR(100), -- EffiSend KYC NFT
kyc_status VARCHAR(20) DEFAULT 'pending',
created_at TIMESTAMP DEFAULT NOW(),
updated_at TIMESTAMP DEFAULT NOW()
);
-- KYC Verification Records
CREATE TABLE kyc_verifications (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES users(id),
effisend_credential_id VARCHAR(100),
verification_level VARCHAR(20), -- basic, advanced, institutional
verified_at TIMESTAMP,
expires_at TIMESTAMP,
verification_proof JSONB, -- Zero-knowledge proof data
INDEX idx_user_kyc (user_id)
);
-- Wallets
CREATE TABLE wallets (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES users(id),
hedera_account_id VARCHAR(50) UNIQUE NOT NULL,
wallet_type VARCHAR(20), -- custodial, non-custodial
balance_usdc DECIMAL(20, 6) DEFAULT 0,
balance_hbar DECIMAL(20, 8) DEFAULT 0,
public_key TEXT,
encrypted_private_key TEXT, -- Only for custodial wallets
created_at TIMESTAMP DEFAULT NOW()
);
-- Transactions
CREATE TABLE transactions (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
hedera_transaction_id VARCHAR(100) UNIQUE NOT NULL,
hcs_topic_id VARCHAR(50), -- Hedera Consensus Service topic
sender_wallet_id UUID REFERENCES wallets(id),
receiver_wallet_id UUID REFERENCES wallets(id),
amount DECIMAL(20, 6) NOT NULL,
currency VARCHAR(10) DEFAULT 'USDC',
transaction_type VARCHAR(20), -- payment, refund, settlement
status VARCHAR(20) DEFAULT 'pending', -- pending, confirmed, failed
httpx402_payment_hash VARCHAR(100),
metadata JSONB,
fee_amount DECIMAL(10, 6),
created_at TIMESTAMP DEFAULT NOW(),
confirmed_at TIMESTAMP,
INDEX idx_sender (sender_wallet_id),
INDEX idx_receiver (receiver_wallet_id),
INDEX idx_status (status),
INDEX idx_created (created_at DESC)
);
-- HTTPx402 Payment Requests
CREATE TABLE payment_requests (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
payment_hash VARCHAR(100) UNIQUE NOT NULL,
resource_url TEXT NOT NULL,
amount DECIMAL(20, 6) NOT NULL,
currency VARCHAR(10) DEFAULT 'USDC',
merchant_wallet_id UUID REFERENCES wallets(id),
status VARCHAR(20) DEFAULT 'pending', -- pending, paid, expired
expires_at TIMESTAMP,
paid_transaction_id UUID REFERENCES transactions(id),
created_at TIMESTAMP DEFAULT NOW(),
INDEX idx_payment_hash (payment_hash),
INDEX idx_status_expires (status, expires_at)
);
-- Smart Contract Interactions
CREATE TABLE smart_contracts (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
hedera_contract_id VARCHAR(50) UNIQUE NOT NULL,
contract_type VARCHAR(50), -- escrow, auto_settlement, compliance
deployed_at TIMESTAMP,
contract_abi JSONB,
status VARCHAR(20) DEFAULT 'active'
);
-- AssetGrid Integration (Future-ready)
CREATE TABLE assetgrid_links (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES users(id),
asset_type VARCHAR(50), -- real_estate, securities, commodities
asset_token_id VARCHAR(100),
linked_at TIMESTAMP DEFAULT NOW(),
metadata JSONB
);
-- Audit Log (Compliance)
CREATE TABLE audit_logs (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES users(id),
action VARCHAR(100) NOT NULL,
resource_type VARCHAR(50),
resource_id UUID,
ip_address INET,
user_agent TEXT,
metadata JSONB,
created_at TIMESTAMP DEFAULT NOW(),
INDEX idx_user_action (user_id, action),
INDEX idx_created (created_at DESC)
);
-- Analytics (For dashboard)
CREATE MATERIALIZED VIEW transaction_analytics AS
SELECT
DATE_TRUNC('day', created_at) as date,
COUNT(*) as transaction_count,
SUM(amount) as total_volume,
AVG(amount) as avg_transaction_size,
currency
FROM transactions
WHERE status = 'confirmed'
GROUP BY DATE_TRUNC('day', created_at), currency;